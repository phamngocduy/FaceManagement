<script async src="@Url.Content("~/Scripts/face-api.min.js")"></script>
<input id="Upload" type="file" style="display:none" />
<canvas id="Canvas" style="width:100%;height:100vh"></canvas>

@section Scripts {
    <script>
        $(function () {
            $('#Upload').change(function () {
                if (this.files && this.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        var canvas = document.getElementById('Canvas');
                        var ctx = canvas.getContext('2d');
                        var image = new Image();

                        image.onload = function () {
                            var img = document.createElement("img");
                            img.src = e.target.result;
                            
                            var ctx = canvas.getContext("2d");
                            ctx.drawImage(img, 0, 0);

                            var width = img.width;
                            var height = img.height;
                            var maxWidth = MAX_WIDTH;
                            var maxHeight = MAX_HEIGHT;

                            if (maxWidth * height / width <= maxHeight) {
                                height = maxWidth * height / width;
                                width = maxWidth;
                            } else {
                                width = maxHeight * width / height;
                                height = maxHeight;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            
                            var ctx = canvas.getContext("2d");
                            switch (ROTATE_VAL) {
                                case "-90":
                                    canvas.width = height;
                                    canvas.height = width;
                                    ctx.transform(1, 0, 0, 1, 0, width);
                                    ctx.rotate(ROTATE_VAL * Math.PI / 180);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    ctx.rotate(-ROTATE_VAL * Math.PI / 180);
                                    ctx.transform(1, 0, 0, 1, 0, -width);
                                    break;
                                case "90":
                                    canvas.width = height;
                                    canvas.height = width;
                                    ctx.transform(1, 0, 0, 1, height, 0);
                                    ctx.rotate(ROTATE_VAL * Math.PI / 180);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    ctx.rotate(-ROTATE_VAL * Math.PI / 180);
                                    ctx.transform(1, 0, 0, 1, -height, 0);
                                    break;
                                case "180":
                                    ctx.transform(1, 0, 0, 1, width, height);
                                    ctx.rotate(ROTATE_VAL * Math.PI / 180);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    ctx.rotate(ROTATE_VAL * Math.PI / 180);
                                    ctx.transform(1, 0, 0, 1, -width, -height);
                                    break;
                                default:
                                    ctx.drawImage(img, 0, 0, width, height);
                            }
                            $(canvas).width('');
                            $(canvas).height('');

                            FaceDetection(canvas);
                        }

                        image.src = e.target.result;
                    };

                    reader.readAsDataURL(this.files[0]);
                }
            });

            $('#Canvas').height($('#Canvas').height() - $('#Canvas').offset().top);
            MAX_WIDTH = $('#Canvas').width(); MAX_HEIGHT = $('#Canvas').height();
            $('#Canvas').width(MAX_WIDTH).height(MAX_HEIGHT).css('border', 'ridge');

            ROTATE_VAL = 0;
            $('[id=Rotate]').click(function () {
                $($(this).parents('ul')[0]).find('li').removeClass('active');
                $($(this).parents('li')[0]).addClass('active');
                ROTATE_VAL = $(this).attr('data-val');
                $.blockUI();
                $('#Upload').trigger('change');
            });
        })
    </script>

    <script>
        const video = document.getElementById('video');

        window.onload = function () {
            $.blockUI();
            NOW = Date.now();
            console.log('Loading models');
            Promise.all([
                faceapi.nets.mtcnn.loadFromUri('@Url.Content("~/Static")'),
                faceapi.nets.ssdMobilenetv1.loadFromUri('@Url.Content("~/Static")'),
                faceapi.nets.tinyFaceDetector.loadFromUri('@Url.Content("~/Static")'),
                faceapi.nets.faceLandmark68Net.loadFromUri('@Url.Content("~/Static")'),
                faceapi.nets.faceRecognitionNet.loadFromUri('@Url.Content("~/Static")'),
                faceapi.nets.faceExpressionNet.loadFromUri('@Url.Content("~/Static")')
            ]).then(logTime);
        }

        function logTime() {
            $.unblockUI();
            console.log('Finished in ' + (Date.now() - NOW));
            NOW = Date.now();
        }

        async function FaceDetection(canvas) {
            $.blockUI();
            NOW = Date.now();
            console.log('Processing image');
            var image = new Image(); image.src = canvas.toDataURL();
            const displaySize = { width: canvas.width, height: canvas.height }
            //faceapi.matchDimensions(canvas, displaySize);
            const detections = await faceapi.detectAllFaces(image, new faceapi.MtcnnOptions()) // faceapi.MtcnnOptions()
                .withFaceLandmarks().withFaceExpressions();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            //canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            faceapi.draw.drawDetections(canvas, resizedDetections);
            //faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
            faceapi.draw.drawFaceExpressions(canvas, resizedDetections);
            $.unblockUI();
            console.log('Finished in ' + (Date.now() - NOW));
            NOW = Date.now();
        }
    </script>

    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
}